name: "Generate Kube Diagram"
on:
  workflow_dispatch: # (https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows)
    inputs:
      tags:
        description: 'Tags to apply to the node'
        required: false
        default: 'tag:gh-runner-node'
        type: string
jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write

    steps:

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Configure Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          tags: ${{ inputs.tags }}
      - name: Configure Kubeconfig
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}
      - name: Kubectl (debug)
        run: |
          kubectl get nodes
      - name: Generate kubernetes manifest
        run: |
          kubectl get all -A -o yaml > manifest.yaml
      - name: "Generate diagram from Kubernetes manifest"
        uses: philippemerle/KubeDiagrams@main
        with:
          type: "kubernetes"
          args: "-o kubediagram.png manifest.yaml"
      # Quick and dirty step to get rid of manifest.yaml
      - run: rm -rf manifest.yaml

      # Commit & add back kubediagram.png (https://github.com/stefanzweifel/git-auto-commit-action)
      - name: Add back changed files
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          # Optional. Commit message for the created commit.
          # Defaults to "Apply automatic changes"
          commit_message: "ci: add kubediagram.png [skip ci]"
          # Optional glob pattern of files which should be added to the commit
          # Defaults to all (.)
          # See the `pathspec`-documentation for git
          # - https://git-scm.com/docs/git-add#Documentation/git-add.txt-ltpathspecgt82308203
          # - https://git-scm.com/docs/gitglossary#Documentation/gitglossary.txt-aiddefpathspecapathspec
          file_pattern: 'kubediagram.png'
      