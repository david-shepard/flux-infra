name: "Generate Kube Diagram"
on:
  workflow_dispatch: # (https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows)
    inputs:
      tags:
        description: 'Tags to apply to the node'
        required: false
        default: 'tag:gh-runner-node'
        type: string

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      # Minimal permissions: read contents + write for commit
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.head_ref }}
          # SECURITY: Use GITHUB_TOKEN instead of PAT to minimize attack surface
          # PATs provide broader access and are high-value targets for attackers
          token: ${{ secrets.GITHUB_TOKEN }}


      - name: Configure Tailscale
        uses: tailscale/github-action@4e7234defdc1e8d49e5bbdd9c2f3cc96c30d9c30 # v3.0.0
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          tags: ${{ inputs.tags }}

      - name: Configure Kubeconfig
        uses: azure/k8s-set-context@3e0aec4d115d9666fbb0e9c78ed9faa4b3114785 # v4.0.0
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}
      - name: Kubectl (debug)
        run: |
          kubectl get nodes
      - name: Generate kubernetes manifest
        run: |
          kubectl get all -A -o yaml > manifest.yaml
      - name: "Generate diagram from Kubernetes manifest"
        # SECURITY WARNING: This action uses @main which is mutable
        # TODO: Pin to specific commit SHA once stable release is available
        uses: philippemerle/KubeDiagrams@main
        with:
          type: "kubernetes"
          args: "-o kubediagram.png manifest.yaml"
      # Quick and dirty step to get rid of manifest.yaml
      - run: rm -rf manifest.yaml

      # Commit & add back kubediagram.png (https://github.com/stefanzweifel/git-auto-commit-action)
      - name: Add back changed files
        uses: stefanzweifel/git-auto-commit-action@0049e3fa4059ca715255fbbcb7dea4516f02ce0a # v6.0.0
        with:
          # Optional. Commit message for the created commit.
          # Defaults to "Apply automatic changes"
          commit_message: "ci: add kubediagram.png [skip ci]"
          # Optional glob pattern of files which should be added to the commit
          # Defaults to all (.)
          # See the `pathspec`-documentation for git
          # - https://git-scm.com/docs/git-add#Documentation/git-add.txt-ltpathspecgt82308203
          # - https://git-scm.com/docs/gitglossary#Documentation/gitglossary.txt-aiddefpathspecapathspec
          file_pattern: 'kubediagram.png'
      
